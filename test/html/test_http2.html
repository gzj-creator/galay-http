<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTTP/2 æµ‹è¯•é¡µé¢</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        
        .header p {
            color: #666;
            font-size: 1.1em;
        }
        
        .status {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #667eea;
        }
        
        .status-item:last-child {
            margin-bottom: 0;
        }
        
        .status-label {
            font-weight: 600;
            color: #333;
        }
        
        .status-value {
            color: #667eea;
            font-weight: 600;
        }
        
        .status-value.success {
            color: #28a745;
        }
        
        .status-value.error {
            color: #dc3545;
        }
        
        .controls {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        button {
            flex: 1;
            min-width: 150px;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }
        
        .btn-info {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
        }
        
        .log-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .log-header h2 {
            color: #333;
            font-size: 1.5em;
        }
        
        .clear-log {
            padding: 8px 20px;
            font-size: 14px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .log-content {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            line-height: 1.6;
        }
        
        .log-entry {
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #333;
        }
        
        .log-entry:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .log-time {
            color: #858585;
            margin-right: 10px;
        }
        
        .log-info {
            color: #4ec9b0;
        }
        
        .log-success {
            color: #4ec9b0;
        }
        
        .log-error {
            color: #f48771;
        }
        
        .log-warning {
            color: #dcdcaa;
        }
        
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .metric-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .metric-value {
            font-size: 2.5em;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .metric-label {
            color: #666;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ HTTP/2 æµ‹è¯•é¡µé¢</h1>
            <p>æµ‹è¯• HTTP/2 è¿æ¥ã€HPACK å‹ç¼©å’Œå¤šè·¯å¤ç”¨åŠŸèƒ½</p>
        </div>
        
        <div class="status">
            <div class="status-item">
                <span class="status-label">åè®®ç‰ˆæœ¬:</span>
                <span class="status-value" id="protocol">æ£€æµ‹ä¸­...</span>
            </div>
            <div class="status-item">
                <span class="status-label">è¿æ¥çŠ¶æ€:</span>
                <span class="status-value" id="connection">æœªè¿æ¥</span>
            </div>
            <div class="status-item">
                <span class="status-label">æœåŠ¡å™¨åœ°å€:</span>
                <span class="status-value" id="server">http://localhost:8080</span>
            </div>
        </div>
        
        <div class="metrics">
            <div class="metric-card">
                <div class="metric-value" id="requestCount">0</div>
                <div class="metric-label">æ€»è¯·æ±‚æ•°</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="successCount">0</div>
                <div class="metric-label">æˆåŠŸè¯·æ±‚</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="errorCount">0</div>
                <div class="metric-label">å¤±è´¥è¯·æ±‚</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="avgTime">0ms</div>
                <div class="metric-label">å¹³å‡å“åº”æ—¶é—´</div>
            </div>
        </div>
        
        <div class="controls">
            <div class="button-group">
                <button class="btn-primary" onclick="testSimpleRequest()">ç®€å•è¯·æ±‚</button>
                <button class="btn-success" onclick="testMultipleRequests()">å¹¶å‘è¯·æ±‚ (x10)</button>
                <button class="btn-info" onclick="testLargeHeaders()">å¤§å¤´éƒ¨æµ‹è¯•</button>
                <button class="btn-warning" onclick="testStreamPriority()">æµä¼˜å…ˆçº§æµ‹è¯•</button>
            </div>
        </div>
        
        <div class="log-container">
            <div class="log-header">
                <h2>ğŸ“‹ è¯·æ±‚æ—¥å¿—</h2>
                <button class="clear-log" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
            </div>
            <div class="log-content" id="logContent"></div>
        </div>
    </div>

    <script>
        let requestCount = 0;
        let successCount = 0;
        let errorCount = 0;
        let totalTime = 0;
        
        // æ£€æµ‹åè®®
        window.addEventListener('load', () => {
            const protocol = window.location.protocol === 'https:' ? 
                (performance.getEntriesByType('navigation')[0]?.nextHopProtocol || 'unknown') : 
                'http/1.1 (éœ€è¦ HTTPS æ‰èƒ½ä½¿ç”¨ h2)';
            
            document.getElementById('protocol').textContent = protocol;
            
            if (protocol.startsWith('h2')) {
                document.getElementById('protocol').classList.add('success');
                log('æ£€æµ‹åˆ° HTTP/2 åè®®', 'success');
            } else {
                document.getElementById('protocol').classList.add('warning');
                log('å½“å‰ä½¿ç”¨ ' + protocol + 'ï¼Œæµ‹è¯• h2c (HTTP/2 over cleartext)', 'warning');
            }
        });
        
        function log(message, type = 'info') {
            const logContent = document.getElementById('logContent');
            const time = new Date().toLocaleTimeString('zh-CN', { hour12: false });
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<span class="log-time">[${time}]</span><span class="log-${type}">${message}</span>`;
            logContent.appendChild(entry);
            logContent.scrollTop = logContent.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('logContent').innerHTML = '';
        }
        
        function updateMetrics() {
            document.getElementById('requestCount').textContent = requestCount;
            document.getElementById('successCount').textContent = successCount;
            document.getElementById('errorCount').textContent = errorCount;
            const avgTime = requestCount > 0 ? Math.round(totalTime / requestCount) : 0;
            document.getElementById('avgTime').textContent = avgTime + 'ms';
        }
        
        async function makeRequest(url, options = {}) {
            const startTime = performance.now();
            requestCount++;
            
            try {
                log(`å‘é€è¯·æ±‚: ${url}`, 'info');
                const response = await fetch(url, {
                    ...options,
                    mode: 'cors',
                    cache: 'no-cache'
                });
                
                const endTime = performance.now();
                const duration = Math.round(endTime - startTime);
                totalTime += duration;
                
                if (response.ok) {
                    successCount++;
                    const data = await response.text();
                    log(`âœ“ è¯·æ±‚æˆåŠŸ (${duration}ms) - çŠ¶æ€: ${response.status}, å¤§å°: ${data.length} å­—èŠ‚`, 'success');
                    
                    // æ˜¾ç¤ºå“åº”å¤´
                    const headers = {};
                    response.headers.forEach((value, key) => {
                        headers[key] = value;
                    });
                    log(`å“åº”å¤´: ${JSON.stringify(headers, null, 2)}`, 'info');
                } else {
                    errorCount++;
                    log(`âœ— è¯·æ±‚å¤±è´¥ (${duration}ms) - çŠ¶æ€: ${response.status}`, 'error');
                }
                
                updateMetrics();
                return response;
            } catch (error) {
                errorCount++;
                const endTime = performance.now();
                const duration = Math.round(endTime - startTime);
                totalTime += duration;
                log(`âœ— è¯·æ±‚å¼‚å¸¸ (${duration}ms): ${error.message}`, 'error');
                updateMetrics();
                throw error;
            }
        }
        
        async function testSimpleRequest() {
            log('========== ç®€å•è¯·æ±‚æµ‹è¯• ==========', 'info');
            try {
                await makeRequest('/api/test', {
                    method: 'GET',
                    headers: {
                        'X-Test-Header': 'simple-request'
                    }
                });
            } catch (error) {
                // Error already logged
            }
        }
        
        async function testMultipleRequests() {
            log('========== å¹¶å‘è¯·æ±‚æµ‹è¯• (10ä¸ª) ==========', 'info');
            const promises = [];
            
            for (let i = 0; i < 10; i++) {
                promises.push(
                    makeRequest(`/api/concurrent/${i}`, {
                        method: 'GET',
                        headers: {
                            'X-Request-ID': `request-${i}`,
                            'X-Timestamp': Date.now().toString()
                        }
                    }).catch(() => {}) // å¿½ç•¥é”™è¯¯ç»§ç»­
                );
            }
            
            try {
                await Promise.all(promises);
                log('æ‰€æœ‰å¹¶å‘è¯·æ±‚å®Œæˆ', 'success');
            } catch (error) {
                log('éƒ¨åˆ†è¯·æ±‚å¤±è´¥', 'warning');
            }
        }
        
        async function testLargeHeaders() {
            log('========== å¤§å¤´éƒ¨æµ‹è¯• (HPACK å‹ç¼©) ==========', 'info');
            
            const largeHeaders = {
                'X-Custom-Header-1': 'value-'.repeat(50),
                'X-Custom-Header-2': 'data-'.repeat(50),
                'X-Custom-Header-3': 'test-'.repeat(50),
                'X-Custom-Header-4': 'http2-'.repeat(50),
                'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36',
                'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
                'Accept-Language': 'zh-CN,zh;q=0.9,en;q=0.8',
                'Accept-Encoding': 'gzip, deflate, br'
            };
            
            log(`å‘é€å¤§å¤´éƒ¨ (${Object.keys(largeHeaders).length} ä¸ªå¤´éƒ¨å­—æ®µ)`, 'info');
            
            try {
                await makeRequest('/api/headers', {
                    method: 'POST',
                    headers: largeHeaders,
                    body: JSON.stringify({ test: 'large headers' })
                });
            } catch (error) {
                // Error already logged
            }
        }
        
        async function testStreamPriority() {
            log('========== æµä¼˜å…ˆçº§æµ‹è¯• ==========', 'info');
            
            // å‘é€å¤šä¸ªä¼˜å…ˆçº§ä¸åŒçš„è¯·æ±‚
            const requests = [
                { url: '/api/priority/high', priority: 'high' },
                { url: '/api/priority/medium', priority: 'medium' },
                { url: '/api/priority/low', priority: 'low' }
            ];
            
            for (const req of requests) {
                log(`å‘é€ ${req.priority} ä¼˜å…ˆçº§è¯·æ±‚`, 'info');
                try {
                    await makeRequest(req.url, {
                        method: 'GET',
                        headers: {
                            'X-Priority': req.priority
                        }
                    });
                } catch (error) {
                    // Error already logged
                }
                // å°å»¶è¿Ÿä»¥ä¾¿è§‚å¯Ÿ
                await new Promise(resolve => setTimeout(resolve, 100));
            }
        }
        
        // å®šæœŸæ›´æ–°è¿æ¥çŠ¶æ€
        setInterval(() => {
            if (navigator.onLine) {
                document.getElementById('connection').textContent = 'åœ¨çº¿';
                document.getElementById('connection').classList.add('success');
                document.getElementById('connection').classList.remove('error');
            } else {
                document.getElementById('connection').textContent = 'ç¦»çº¿';
                document.getElementById('connection').classList.add('error');
                document.getElementById('connection').classList.remove('success');
            }
        }, 1000);
        
        // åˆå§‹åŒ–
        log('HTTP/2 æµ‹è¯•é¡µé¢å·²åŠ è½½', 'success');
        log('æç¤º: æµè§ˆå™¨åŸç”Ÿæ”¯æŒ HTTP/2 éœ€è¦ HTTPS (h2)ï¼ŒHTTP ä½¿ç”¨ h2c', 'info');
    </script>
</body>
</html>

