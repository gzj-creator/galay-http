<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTTP/2 over TLS (h2) æµ‹è¯•é¡µé¢</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .header h1 {
            color: #2c5364;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        
        .header .subtitle {
            color: #666;
            font-size: 1.1em;
            margin-bottom: 15px;
        }
        
        .security-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9em;
        }
        
        .status {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #2c5364;
        }
        
        .status-item:last-child {
            margin-bottom: 0;
        }
        
        .status-label {
            font-weight: 600;
            color: #333;
        }
        
        .status-value {
            color: #2c5364;
            font-weight: 600;
        }
        
        .status-value.success {
            color: #28a745;
        }
        
        .status-value.error {
            color: #dc3545;
        }
        
        .status-value.warning {
            color: #ffc107;
        }
        
        .controls {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        button {
            flex: 1;
            min-width: 150px;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #2c5364 0%, #0f2027 100%);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }
        
        .btn-info {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }
        
        .log-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .log-header h2 {
            color: #333;
            font-size: 1.5em;
        }
        
        .clear-log {
            padding: 8px 20px;
            font-size: 14px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .log-content {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            line-height: 1.6;
        }
        
        .log-entry {
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #333;
        }
        
        .log-entry:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .log-time {
            color: #858585;
            margin-right: 10px;
        }
        
        .log-info {
            color: #4ec9b0;
        }
        
        .log-success {
            color: #4ec9b0;
        }
        
        .log-error {
            color: #f48771;
        }
        
        .log-warning {
            color: #dcdcaa;
        }
        
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .metric-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .metric-value {
            font-size: 2.5em;
            font-weight: 700;
            color: #2c5364;
            margin-bottom: 10px;
        }
        
        .metric-label {
            color: #666;
            font-size: 0.9em;
        }
        
        .warning-box {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 5px;
            padding: 15px;
            margin-top: 15px;
            color: #856404;
        }
        
        .warning-box strong {
            display: block;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”’ HTTP/2 over TLS (h2) æµ‹è¯•é¡µé¢</h1>
            <p class="subtitle">æµ‹è¯• HTTPS + HTTP/2 è¿æ¥ã€ALPN åå•†å’Œå®‰å…¨ä¼ è¾“</p>
            <div class="security-badge">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z"/>
                </svg>
                HTTPS + HTTP/2 (h2)
            </div>
            <div class="warning-box">
                <strong>âš ï¸ è¯ä¹¦è­¦å‘Šè¯´æ˜ï¼š</strong>
                æµ‹è¯•æœåŠ¡å™¨ä½¿ç”¨è‡ªç­¾åè¯ä¹¦ï¼Œæµè§ˆå™¨ä¼šæ˜¾ç¤ºå®‰å…¨è­¦å‘Šã€‚è¿™æ˜¯æ­£å¸¸çš„ï¼Œç‚¹å‡»"é«˜çº§"ç„¶å"ç»§ç»­è®¿é—®"å³å¯ã€‚
            </div>
        </div>
        
        <div class="status">
            <div class="status-item">
                <span class="status-label">åè®®ç‰ˆæœ¬:</span>
                <span class="status-value" id="protocol">æ£€æµ‹ä¸­...</span>
            </div>
            <div class="status-item">
                <span class="status-label">å®‰å…¨è¿æ¥:</span>
                <span class="status-value" id="security">æ£€æµ‹ä¸­...</span>
            </div>
            <div class="status-item">
                <span class="status-label">ALPN åå•†:</span>
                <span class="status-value" id="alpn">æ£€æµ‹ä¸­...</span>
            </div>
            <div class="status-item">
                <span class="status-label">æœåŠ¡å™¨åœ°å€:</span>
                <span class="status-value" id="server">https://localhost:8443</span>
            </div>
        </div>
        
        <div class="metrics">
            <div class="metric-card">
                <div class="metric-value" id="requestCount">0</div>
                <div class="metric-label">æ€»è¯·æ±‚æ•°</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="successCount">0</div>
                <div class="metric-label">æˆåŠŸè¯·æ±‚</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="errorCount">0</div>
                <div class="metric-label">å¤±è´¥è¯·æ±‚</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="avgTime">0ms</div>
                <div class="metric-label">å¹³å‡å“åº”æ—¶é—´</div>
            </div>
        </div>
        
        <div class="controls">
            <div class="button-group">
                <button class="btn-primary" onclick="testSimpleRequest()">ç®€å• POST (è§¦å‘ onData)</button>
                <button class="btn-success" onclick="testGetRequest()">GET è¯·æ±‚ (ä»… onHeaders)</button>
                <button class="btn-info" onclick="testMultipleRequests()">å¹¶å‘ POST (x10)</button>
                <button class="btn-warning" onclick="testLargeHeaders()">å¤§å¤´éƒ¨æµ‹è¯•</button>
                <button class="btn-danger" onclick="testStressRequests()">å‹åŠ›æµ‹è¯• (x50)</button>
            </div>
        </div>
        
        <div class="log-container">
            <div class="log-header">
                <h2>ğŸ“‹ è¯·æ±‚æ—¥å¿—</h2>
                <button class="clear-log" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
            </div>
            <div class="log-content" id="logContent"></div>
        </div>
    </div>

    <script>
        const SERVER_URL = 'https://localhost:8443';
        let requestCount = 0;
        let successCount = 0;
        let errorCount = 0;
        let totalTime = 0;
        
        // æ£€æµ‹åè®®å’Œå®‰å…¨æ€§
        window.addEventListener('load', async () => {
            // æ£€æŸ¥æ˜¯å¦ä½¿ç”¨ HTTPS
            if (window.location.protocol === 'https:') {
                document.getElementById('security').textContent = 'âœ“ HTTPS åŠ å¯†';
                document.getElementById('security').classList.add('success');
                log('âœ“ ä½¿ç”¨ HTTPS å®‰å…¨è¿æ¥', 'success');
                
                // æ£€æµ‹ HTTP/2
                try {
                    const navEntry = performance.getEntriesByType('navigation')[0];
                    const protocol = navEntry?.nextHopProtocol || 'unknown';
                    
                    document.getElementById('protocol').textContent = protocol;
                    
                    if (protocol === 'h2') {
                        document.getElementById('protocol').classList.add('success');
                        document.getElementById('alpn').textContent = 'âœ“ ALPN åå•†æˆåŠŸ';
                        document.getElementById('alpn').classList.add('success');
                        log('âœ“ æ£€æµ‹åˆ° HTTP/2 (h2) åè®®', 'success');
                        log('âœ“ ALPN åå•†æˆåŠŸï¼Œä½¿ç”¨ h2', 'success');
                    } else if (protocol.startsWith('http/1')) {
                        document.getElementById('protocol').classList.add('warning');
                        document.getElementById('alpn').textContent = 'âœ— é™çº§åˆ° HTTP/1.1';
                        document.getElementById('alpn').classList.add('warning');
                        log('âš  å½“å‰ä½¿ç”¨ ' + protocol + 'ï¼ŒæœåŠ¡å™¨å¯èƒ½ä¸æ”¯æŒ HTTP/2', 'warning');
                    } else {
                        document.getElementById('protocol').classList.add('warning');
                        document.getElementById('alpn').textContent = 'æœªçŸ¥';
                        document.getElementById('alpn').classList.add('warning');
                        log('âš  æ— æ³•æ£€æµ‹åè®®ç‰ˆæœ¬: ' + protocol, 'warning');
                    }
                } catch (error) {
                    log('âš  æ— æ³•æ£€æµ‹åè®®: ' + error.message, 'error');
                }
            } else {
                document.getElementById('security').textContent = 'âœ— HTTP (ä¸å®‰å…¨)';
                document.getElementById('security').classList.add('error');
                document.getElementById('alpn').textContent = 'N/A (éœ€è¦ HTTPS)';
                document.getElementById('alpn').classList.add('error');
                log('âœ— å½“å‰ä½¿ç”¨ HTTPï¼Œh2 éœ€è¦ HTTPS', 'error');
                log('è¯·é€šè¿‡ HTTPS è®¿é—®æ­¤é¡µé¢', 'warning');
            }
            
            // æµ‹è¯•æœåŠ¡å™¨è¿æ¥
            await testConnection();
        });
        
        async function testConnection() {
            log('æµ‹è¯•æœåŠ¡å™¨è¿æ¥...', 'info');
            try {
                const response = await fetch(SERVER_URL + '/', {
                    method: 'GET',
                    cache: 'no-cache'
                });
                
                if (response.ok) {
                    log('âœ“ æœåŠ¡å™¨è¿æ¥æˆåŠŸ', 'success');
                    
                    // æ£€æŸ¥å“åº”å¤´ä¸­çš„æœåŠ¡å™¨ä¿¡æ¯
                    const server = response.headers.get('server');
                    if (server) {
                        log(`æœåŠ¡å™¨: ${server}`, 'info');
                    }
                } else {
                    log(`âš  æœåŠ¡å™¨å“åº”å¼‚å¸¸: ${response.status}`, 'warning');
                }
            } catch (error) {
                log(`âœ— æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨: ${error.message}`, 'error');
                log('è¯·ç¡®ä¿æœåŠ¡å™¨å·²å¯åŠ¨å¹¶ç›‘å¬åœ¨ https://localhost:8443', 'warning');
            }
        }
        
        function log(message, type = 'info') {
            const logContent = document.getElementById('logContent');
            const time = new Date().toLocaleTimeString('zh-CN', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit', fractionalSecondDigits: 3 });
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<span class="log-time">[${time}]</span><span class="log-${type}">${message}</span>`;
            logContent.appendChild(entry);
            logContent.scrollTop = logContent.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('logContent').innerHTML = '';
            log('æ—¥å¿—å·²æ¸…ç©º', 'info');
        }
        
        function updateMetrics() {
            document.getElementById('requestCount').textContent = requestCount;
            document.getElementById('successCount').textContent = successCount;
            document.getElementById('errorCount').textContent = errorCount;
            const avgTime = requestCount > 0 ? Math.round(totalTime / requestCount) : 0;
            document.getElementById('avgTime').textContent = avgTime + 'ms';
        }
        
        async function makeRequest(url, options = {}) {
            const startTime = performance.now();
            requestCount++;
            
            try {
                log(`â†’ å‘é€è¯·æ±‚: ${url}`, 'info');
                const response = await fetch(SERVER_URL + url, {
                    ...options,
                    cache: 'no-cache'
                });
                
                const endTime = performance.now();
                const duration = Math.round(endTime - startTime);
                totalTime += duration;
                
                if (response.ok) {
                    successCount++;
                    const data = await response.text();
                    log(`âœ“ è¯·æ±‚æˆåŠŸ (${duration}ms) - çŠ¶æ€: ${response.status}, å¤§å°: ${data.length} å­—èŠ‚`, 'success');
                    
                    // æ˜¾ç¤ºé‡è¦çš„å“åº”å¤´
                    const headers = {};
                    const importantHeaders = ['content-type', 'content-length', 'server', 'x-stream-id'];
                    importantHeaders.forEach(key => {
                        const value = response.headers.get(key);
                        if (value) headers[key] = value;
                    });
                    if (Object.keys(headers).length > 0) {
                        log(`  å“åº”å¤´: ${JSON.stringify(headers)}`, 'info');
                    }
                } else {
                    errorCount++;
                    log(`âœ— è¯·æ±‚å¤±è´¥ (${duration}ms) - çŠ¶æ€: ${response.status} ${response.statusText}`, 'error');
                }
                
                updateMetrics();
                return response;
            } catch (error) {
                errorCount++;
                const endTime = performance.now();
                const duration = Math.round(endTime - startTime);
                totalTime += duration;
                log(`âœ— è¯·æ±‚å¼‚å¸¸ (${duration}ms): ${error.message}`, 'error');
                updateMetrics();
                throw error;
            }
        }
        
        async function testSimpleRequest() {
            log('========== ç®€å•è¯·æ±‚æµ‹è¯• (POST) ==========', 'info');
            log('å‘é€ POST è¯·æ±‚ä»¥è§¦å‘ onData å›è°ƒ...', 'info');
            try {
                const data = {
                    message: 'Simple POST request',
                    timestamp: Date.now()
                };
                await makeRequest('/api/echo', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
            } catch (error) {
                // Error already logged
            }
        }
        
        async function testGetRequest() {
            log('========== GET è¯·æ±‚æµ‹è¯• ==========', 'info');
            log('GET è¯·æ±‚æ²¡æœ‰ bodyï¼Œåªä¼šè§¦å‘ onHeaders å›è°ƒ', 'info');
            try {
                await makeRequest('/api/hello', {
                    method: 'GET'
                });
            } catch (error) {
                // Error already logged
            }
        }
        
        async function testMultipleRequests() {
            log('========== å¹¶å‘ POST è¯·æ±‚æµ‹è¯• (10ä¸ª) ==========', 'info');
            log('æµ‹è¯• HTTP/2 å¤šè·¯å¤ç”¨èƒ½åŠ› + onData å›è°ƒ...', 'info');
            
            const promises = [];
            for (let i = 0; i < 10; i++) {
                const data = {
                    request_id: i,
                    message: `Concurrent request ${i}`,
                    timestamp: Date.now()
                };
                promises.push(
                    makeRequest(`/api/echo`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Request-ID': `concurrent-${i}`,
                            'X-Timestamp': Date.now().toString()
                        },
                        body: JSON.stringify(data)
                    }).catch(() => {})
                );
            }
            
            const start = performance.now();
            try {
                await Promise.all(promises);
                const duration = Math.round(performance.now() - start);
                log(`âœ“ æ‰€æœ‰å¹¶å‘è¯·æ±‚å®Œæˆï¼Œæ€»è€—æ—¶: ${duration}ms`, 'success');
                log(`  æ¯ä¸ªè¯·æ±‚éƒ½ä¼šè§¦å‘ onHeaders + onData`, 'info');
            } catch (error) {
                log('âš  éƒ¨åˆ†è¯·æ±‚å¤±è´¥', 'warning');
            }
        }
        
        async function testLargeHeaders() {
            log('========== å¤§å¤´éƒ¨ POST æµ‹è¯• (HPACK å‹ç¼©) ==========', 'info');
            
            const largeHeaders = {
                'X-Custom-Header-1': 'value-'.repeat(100),
                'X-Custom-Header-2': 'data-'.repeat(100),
                'X-Custom-Header-3': 'test-'.repeat(100),
                'X-Custom-Header-4': 'http2-'.repeat(100),
                'X-Custom-Header-5': 'compression-'.repeat(100),
                'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
                'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8',
                'Accept-Language': 'zh-CN,zh;q=0.9,en;q=0.8,ja;q=0.7',
                'Accept-Encoding': 'gzip, deflate, br',
                'Content-Type': 'application/json'
            };
            
            const totalSize = Object.entries(largeHeaders).reduce((sum, [key, value]) => 
                sum + key.length + value.length, 0);
            
            log(`å‘é€å¤§å¤´éƒ¨ (${Object.keys(largeHeaders).length} ä¸ªå­—æ®µ, ~${totalSize} å­—èŠ‚)`, 'info');
            log('HTTP/2 å°†ä½¿ç”¨ HPACK å‹ç¼©è¿™äº›å¤´éƒ¨...', 'info');
            
            const bodyData = {
                message: 'Testing HPACK compression',
                large_headers: true,
                timestamp: Date.now()
            };
            
            try {
                await makeRequest('/api/echo', {
                    method: 'POST',
                    headers: largeHeaders,
                    body: JSON.stringify(bodyData)
                });
            } catch (error) {
                // Error already logged
            }
        }
        
        async function testStressRequests() {
            log('========== å‹åŠ›æµ‹è¯• (50ä¸ªå¹¶å‘ POST è¯·æ±‚) ==========', 'info');
            log('âš ï¸ è¿™å°†å‘é€ 50 ä¸ªå¹¶å‘ POST è¯·æ±‚ï¼ˆæ¯ä¸ªéƒ½ä¼šè§¦å‘ onDataï¼‰...', 'warning');
            
            const promises = [];
            for (let i = 0; i < 50; i++) {
                const data = {
                    request_id: i,
                    message: `Stress test request ${i}`,
                    timestamp: Date.now()
                };
                promises.push(
                    makeRequest('/api/echo', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Request-ID': `stress-${i}`
                        },
                        body: JSON.stringify(data)
                    }).catch(() => {})
                );
            }
            
            const start = performance.now();
            try {
                await Promise.all(promises);
                const duration = Math.round(performance.now() - start);
                log(`âœ“ å‹åŠ›æµ‹è¯•å®Œæˆï¼Œæ€»è€—æ—¶: ${duration}ms`, 'success');
                log(`  å¹³å‡æ¯è¯·æ±‚: ${Math.round(duration / 50)}ms`, 'info');
                log(`  æ€»å…±è§¦å‘äº† ${50} æ¬¡ onHeaders + ${50} æ¬¡ onData å›è°ƒ`, 'info');
            } catch (error) {
                log('âš  å‹åŠ›æµ‹è¯•éƒ¨åˆ†å¤±è´¥', 'warning');
            }
        }
        
        // åˆå§‹åŒ–
        log('HTTP/2 over TLS (h2) æµ‹è¯•é¡µé¢å·²åŠ è½½', 'success');
        log('è¯´æ˜: h2 ä½¿ç”¨ HTTPS + ALPN åå•† HTTP/2 è¿æ¥', 'info');
        log('', 'info');
        log('ğŸ’¡ æç¤ºï¼š', 'info');
        log('  â€¢ POST è¯·æ±‚ä¼šè§¦å‘æœåŠ¡å™¨çš„ onHeaders + onData å›è°ƒ', 'info');
        log('  â€¢ GET è¯·æ±‚åªä¼šè§¦å‘æœåŠ¡å™¨çš„ onHeaders å›è°ƒï¼ˆæ— è¯·æ±‚ä½“ï¼‰', 'info');
    </script>
</body>
</html>

