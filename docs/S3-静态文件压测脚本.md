# S3-静态文件压测脚本文档

## 脚本概述

`S3-BenchmarkStaticFiles.sh` 是一个专门用于静态文件服务性能压测的脚本。该脚本使用 `wrk` 或 `ab`（Apache Bench）工具对静态文件服务器进行全面的性能测试，涵盖不同文件大小、不同文件类型以及动态/静态挂载模式的对比测试。

## 功能说明

### 主要功能

1. **多场景压测**：测试主页、API、HTML、CSS、JS、JSON 等多种资源类型
2. **文件大小对比**：测试小文件（1KB）、中等文件（1MB）、大文件（10MB）的性能差异
3. **挂载模式对比**：对比动态挂载（mount）和静态挂载（mountHardly）的性能
4. **自动工具选择**：自动检测并使用 `wrk` 或 `ab` 工具
5. **服务器状态检查**：压测前自动检查服务器是否运行

### 核心特性

- **彩色输出**：使用颜色区分不同测试阶段和结果
- **灵活配置**：支持自定义压测参数（持续时间、线程数、连接数）
- **详细报告**：每个测试场景都有独立的性能报告
- **自动等待**：测试间自动等待，避免服务器过载

## 使用方法

### 基本语法

```bash
./scripts/S3-BenchmarkStaticFiles.sh
```

### 前置条件

1. **启动测试服务器**：
   ```bash
   cd build/test
   ./test_static_file_server
   ```

2. **安装压测工具**（二选一）：
   ```bash
   # macOS - 安装 wrk
   brew install wrk

   # Linux - 安装 ab
   apt-get install apache2-utils

   # macOS - 安装 ab
   brew install httpd
   ```

### 配置参数

脚本内置的默认配置：

```bash
SERVER_HOST="localhost"      # 服务器地址
SERVER_PORT="8080"           # 服务器端口
DURATION="30s"               # 压测持续时间
THREADS=4                    # 线程数
CONNECTIONS=100              # 并发连接数
```

可以通过修改脚本开头的变量来自定义配置。

## 使用示例

### 1. 基本使用流程

```bash
# 步骤 1: 启动测试服务器
cd build/test
./test_static_file_server &

# 步骤 2: 运行压测脚本
cd ../..
./scripts/S3-BenchmarkStaticFiles.sh

# 步骤 3: 查看压测结果
# 脚本会自动输出所有测试场景的性能数据
```

### 2. 自定义压测参数

修改脚本中的配置变量：

```bash
# 编辑脚本
vim scripts/S3-BenchmarkStaticFiles.sh

# 修改以下参数
DURATION="60s"        # 增加压测时间到 60 秒
THREADS=8             # 增加线程数到 8
CONNECTIONS=200       # 增加并发连接数到 200
```

### 3. 使用不同的压测工具

脚本会自动检测可用的压测工具：

**优先使用 wrk**：
```bash
# 安装 wrk
brew install wrk

# 运行脚本（自动使用 wrk）
./scripts/S3-BenchmarkStaticFiles.sh
```

**使用 ab**：
```bash
# 如果未安装 wrk，脚本会自动使用 ab
# 或者卸载 wrk 强制使用 ab
brew uninstall wrk

# 运行脚本（自动使用 ab）
./scripts/S3-BenchmarkStaticFiles.sh
```

## 测试场景详解

### 测试场景列表

脚本包含以下 11 个测试场景：

| 序号 | 测试场景 | URL | 文件大小 | 说明 |
|------|----------|-----|----------|------|
| 1 | 主页 | `/` | - | 测试根路径响应 |
| 2 | API 状态 | `/api/status` | - | 测试 API 接口性能 |
| 3 | HTML 文件（动态） | `/static/index.html` | ~1KB | 动态挂载模式 |
| 4 | HTML 文件（静态） | `/files/index.html` | ~1KB | 静态挂载模式 |
| 5 | CSS 文件（动态） | `/static/css/style.css` | ~200B | 样式表文件 |
| 6 | JS 文件（静态） | `/files/js/app.js` | ~100B | JavaScript 文件 |
| 7 | JSON 文件（动态） | `/static/docs/data.json` | ~150B | JSON 数据文件 |
| 8 | 小二进制文件 | `/static/small.bin` | 10KB | 小文件性能 |
| 9 | 中等二进制文件 | `/static/medium.bin` | 1MB | 中等文件性能 |
| 10 | 大二进制文件 | `/static/large.bin` | 10MB | 大文件性能 |
| 11 | 动态 vs 静态对比 | 两种模式 | 10KB | 挂载模式对比 |

### 场景 1: 主页测试

**目的**：测试根路径的响应性能

**URL**：`http://localhost:8080/`

**预期结果**：
- 高吞吐量（通常 > 10,000 req/s）
- 低延迟（< 10ms）

### 场景 2: API 状态测试

**目的**：测试 API 接口的性能

**URL**：`http://localhost:8080/api/status`

**预期结果**：
- 返回 JSON 格式的服务器状态
- 性能应与主页相当

### 场景 3-7: 不同文件类型测试

**目的**：测试不同 MIME 类型文件的传输性能

**文件类型**：
- HTML（text/html）
- CSS（text/css）
- JavaScript（application/javascript）
- JSON（application/json）

**预期结果**：
- 小文件（< 1KB）性能相近
- 主要瓶颈在网络往返时间（RTT）

### 场景 8-10: 不同文件大小测试

**目的**：测试不同文件大小对性能的影响

**文件大小**：
- 小文件：10KB
- 中等文件：1MB
- 大文件：10MB

**预期结果**：
- 小文件：高吞吐量，低延迟
- 中等文件：吞吐量下降，延迟增加
- 大文件：吞吐量显著下降，延迟显著增加

### 场景 11: 动态 vs 静态模式对比

**目的**：对比两种挂载模式的性能差异

**挂载模式**：
- **动态挂载（mount）**：每次请求都读取文件
- **静态挂载（mountHardly）**：文件内容缓存在内存

**预期结果**：
- 静态模式性能显著优于动态模式
- 静态模式适合不变的静态资源
- 动态模式适合频繁更新的文件

## 压测工具对比

### wrk vs ab

| 特性 | wrk | ab |
|------|-----|-----|
| 性能 | 更高（多线程） | 较低（单线程） |
| 延迟统计 | 支持（--latency） | 不支持 |
| 持续时间 | 支持（-d） | 不支持（仅支持请求数） |
| 脚本支持 | 支持 Lua 脚本 | 不支持 |
| 安装难度 | 简单 | 简单 |
| 平台支持 | Linux, macOS | Linux, macOS, Windows |

### wrk 输出示例

```
Running 30s test @ http://localhost:8080/static/small.bin
  4 threads and 100 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     2.15ms    1.23ms  45.67ms   89.34%
    Req/Sec    12.34k     1.23k   15.67k    78.90%
  Latency Distribution
     50%    1.98ms
     75%    2.45ms
     90%    3.12ms
     99%    5.67ms
  1234567 requests in 30.00s, 12.34GB read
Requests/sec:  41152.33
Transfer/sec:    421.23MB
```

### ab 输出示例

```
Benchmarking localhost (be patient)
Completed 10000 requests
...
Finished 100000 requests

Server Software:        galay-http
Server Hostname:        localhost
Server Port:            8080

Document Path:          /static/small.bin
Document Length:        10240 bytes

Concurrency Level:      100
Time taken for tests:   2.456 seconds
Complete requests:      100000
Failed requests:        0
Total transferred:      1024000000 bytes
HTML transferred:       1024000000 bytes
Requests per second:    40714.29 [#/sec] (mean)
Time per request:       2.456 [ms] (mean)
Time per request:       0.025 [ms] (mean, across all concurrent requests)
Transfer rate:          407142.86 [Kbytes/sec] received
```

## 性能指标说明

### 关键指标

#### 1. 吞吐量（Throughput）

**定义**：每秒处理的请求数（Requests/sec）

**计算公式**：
```
吞吐量 = 总请求数 / 总耗时
```

**参考值**：
- 小文件（< 10KB）：> 40,000 req/s
- 中等文件（1MB）：> 5,000 req/s
- 大文件（10MB）：> 500 req/s

#### 2. 延迟（Latency）

**定义**：单个请求的响应时间

**统计指标**：
- **平均延迟（Avg）**：所有请求的平均响应时间
- **标准差（Stdev）**：延迟的波动程度
- **最大延迟（Max）**：最慢的请求响应时间
- **百分位延迟**：
  - P50（中位数）：50% 的请求延迟低于此值
  - P75：75% 的请求延迟低于此值
  - P90：90% 的请求延迟低于此值
  - P99：99% 的请求延迟低于此值

**参考值**：
- 小文件：P99 < 10ms
- 中等文件：P99 < 50ms
- 大文件：P99 < 200ms

#### 3. 传输速率（Transfer Rate）

**定义**：每秒传输的数据量（MB/s）

**计算公式**：
```
传输速率 = 总传输字节数 / 总耗时
```

**参考值**：
- 千兆网卡理论上限：~125 MB/s
- 实际可达：80-100 MB/s

#### 4. 失败率（Error Rate）

**定义**：失败请求占总请求的比例

**计算公式**：
```
失败率 = 失败请求数 / 总请求数 × 100%
```

**参考值**：
- 正常情况：0%
- 可接受范围：< 0.1%

## 工作流程

### 执行流程图

```
开始
  ↓
检查服务器是否运行
  ↓
检测可用的压测工具（wrk/ab）
  ↓
场景 1: 主页压测
  ↓
场景 2: API 压测
  ↓
场景 3-7: 不同文件类型压测
  ↓
场景 8-10: 不同文件大小压测
  ↓
场景 11: 动态 vs 静态对比
  ↓
获取服务器最终状态
  ↓
结束
```

### 测试间等待

脚本在每个测试场景之间会等待 2 秒，目的是：
1. 让服务器恢复到稳定状态
2. 避免前一个测试的影响
3. 防止服务器过载

## 错误处理

### 常见错误及解决方案

#### 1. 服务器未运行

**错误信息**：
```
Error: Server is not running at http://localhost:8080
Please start the server first:
  cd build && ./test_static_file_server
```

**解决方案**：
```bash
# 启动测试服务器
cd build/test
./test_static_file_server

# 或在后台运行
./test_static_file_server &
```

#### 2. 压测工具未安装

**错误信息**：
```
Error: Neither wrk nor ab found
Please install one of them:
  macOS: brew install wrk
  Linux: apt-get install apache2-utils (for ab)
```

**解决方案**：
```bash
# macOS - 安装 wrk（推荐）
brew install wrk

# 或安装 ab
brew install httpd

# Linux - 安装 ab
sudo apt-get install apache2-utils

# 或安装 wrk
sudo apt-get install wrk
```

#### 3. 端口被占用

**错误信息**：
服务器启动失败，提示端口已被占用

**解决方案**：
```bash
# 查找占用端口的进程
lsof -i :8080

# 杀死占用端口的进程
kill -9 <PID>

# 或修改脚本中的端口号
SERVER_PORT="8081"
```

#### 4. 测试文件不存在

**错误信息**：
压测返回 404 Not Found

**解决方案**：
```bash
# 检查测试文件是否存在
ls -la build/test/static/

# 如果缺少测试文件，重新生成
cd build/test
./test_static_file_server --generate-test-files
```

## 注意事项

### 使用建议

1. **服务器准备**：
   - 确保服务器已启动并正常运行
   - 检查服务器日志，确认无错误
   - 确保测试文件已正确生成

2. **系统资源**：
   - 关闭不必要的后台程序
   - 确保有足够的内存和 CPU 资源
   - 监控系统资源使用情况

3. **网络环境**：
   - 使用本地回环（localhost）避免网络延迟
   - 关闭防火墙或添加例外规则
   - 避免在网络拥堵时进行测试

4. **测试时机**：
   - 在系统负载较低时进行测试
   - 多次运行取平均值
   - 记录测试环境和配置

### 最佳实践

1. **基准测试流程**：
   ```bash
   # 1. 清理环境
   pkill test_static_file_server

   # 2. 重新编译（Release 模式）
   cd build
   cmake -DCMAKE_BUILD_TYPE=Release ..
   make test_static_file_server

   # 3. 启动服务器
   cd test
   ./test_static_file_server &

   # 4. 等待服务器启动
   sleep 2

   # 5. 运行压测
   cd ../..
   ./scripts/S3-BenchmarkStaticFiles.sh

   # 6. 保存结果
   ./scripts/S3-BenchmarkStaticFiles.sh > benchmark_results.txt 2>&1
   ```

2. **性能对比测试**：
   ```bash
   # 测试优化前的性能
   git checkout main
   # 编译并运行压测
   ./scripts/S3-BenchmarkStaticFiles.sh > results_before.txt

   # 测试优化后的性能
   git checkout feature/optimization
   # 编译并运行压测
   ./scripts/S3-BenchmarkStaticFiles.sh > results_after.txt

   # 对比结果
   diff results_before.txt results_after.txt
   ```

3. **持续性能监控**：
   ```bash
   # 定期运行压测并记录结果
   DATE=$(date +%Y%m%d_%H%M%S)
   ./scripts/S3-BenchmarkStaticFiles.sh > "benchmark_${DATE}.txt"

   # 使用 git 跟踪性能变化
   git add "benchmark_${DATE}.txt"
   git commit -m "perf: benchmark results for ${DATE}"
   ```

## 脚本实现细节

### 关键函数

#### 1. `benchmark(name, url, file_size)`

**功能**：执行单个压测场景

**参数**：
- `name`：测试场景名称
- `url`：测试 URL
- `file_size`：文件大小（可选，用于显示）

**实现**：
```bash
benchmark() {
    local name=$1
    local url=$2
    local file_size=$3

    echo -e "${BLUE}========================================${NC}"
    echo -e "${BLUE}Testing: ${name}${NC}"
    echo -e "${BLUE}URL: ${url}${NC}"
    if [ -n "$file_size" ]; then
        echo -e "${BLUE}File Size: ${file_size}${NC}"
    fi
    echo -e "${BLUE}========================================${NC}"

    if [ "$TOOL" = "wrk" ]; then
        wrk -t${THREADS} -c${CONNECTIONS} -d${DURATION} --latency "${url}"
    else
        local requests=$((CONNECTIONS * 1000))
        ab -n ${requests} -c ${CONNECTIONS} -g /dev/null "${url}"
    fi

    echo -e "\n"
    sleep 2
}
```

#### 2. 服务器状态检查

**实现**：
```bash
if ! curl -s "${BASE_URL}/api/status" > /dev/null 2>&1; then
    echo -e "${RED}Error: Server is not running at ${BASE_URL}${NC}"
    exit 1
fi
```

#### 3. 工具检测

**实现**：
```bash
TOOL=""
if command -v wrk &> /dev/null; then
    TOOL="wrk"
elif command -v ab &> /dev/null; then
    TOOL="ab"
else
    echo -e "${RED}Error: Neither wrk nor ab found${NC}"
    exit 1
fi
```

### 颜色输出

- **蓝色**：测试场景标题（`\033[0;34m`）
- **绿色**：成功信息（`\033[0;32m`）
- **红色**：错误信息（`\033[0;31m`）
- **黄色**：警告信息（`\033[1;33m`）

## 扩展功能

### 自定义测试场景

可以添加自定义测试场景：

```bash
# 添加新的测试场景
benchmark "Custom Test" "${BASE_URL}/custom/path" "5MB"
```

### 生成性能报告

可以将结果导出为结构化格式：

```bash
# 导出为文本文件
./scripts/S3-BenchmarkStaticFiles.sh > benchmark_report.txt 2>&1

# 提取关键指标
grep "Requests/sec" benchmark_report.txt
grep "Transfer/sec" benchmark_report.txt
```

### 集成监控工具

可以结合系统监控工具：

```bash
# 同时监控系统资源
./scripts/S3-BenchmarkStaticFiles.sh &
BENCH_PID=$!

# 监控 CPU 和内存
while kill -0 $BENCH_PID 2>/dev/null; do
    top -l 1 | grep "test_static_file_server"
    sleep 5
done
```

## 相关脚本

- **S1-Run.sh**：运行测试和示例的通用脚本
- **S2-Check.sh**：验证测试结果和压测指标
- **S4-TestRangeEtagManual.sh**：HTTP Range 和 ETag 手动测试
- **S5-TestRangeEtagStress.sh**：HTTP Range 和 ETag 压力测试

## 技术规格

| 项目 | 说明 |
|------|------|
| Shell 版本 | Bash 3.2+ |
| 依赖工具 | wrk 或 ab, curl |
| 支持平台 | Linux, macOS |
| 脚本位置 | `scripts/S3-BenchmarkStaticFiles.sh` |
| 默认端口 | 8080 |
| 默认持续时间 | 30 秒 |
| 默认并发数 | 100 |

---

**文档版本**：v1.0
**创建日期**：2026-01-29
**维护团队**：galay-http 开发团队
