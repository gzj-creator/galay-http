# S1-运行脚本文档

## 脚本概述

`S1-Run.sh` 是一个通用的运行脚本，用于执行项目中的测试、示例和压测程序。该脚本提供了统一的命令行接口，简化了各类可执行文件的运行流程。

## 功能说明

### 主要功能

1. **运行测试文件**：执行 `build/test/` 目录下的测试程序
2. **运行示例文件**：执行 `build/example/` 目录下的示例程序
3. **运行压测文件**：执行 `build/benchmark/` 目录下的压测程序
4. **批量运行测试**：一次性运行所有测试文件并统计结果

### 核心特性

- **自动路径解析**：自动定位项目根目录和构建目录
- **彩色输出**：使用颜色区分成功、失败和警告信息
- **错误检查**：运行前检查构建目录和可执行文件是否存在
- **统计报告**：批量测试时提供通过/失败统计

## 使用方法

### 基本语法

```bash
./scripts/S1-Run.sh [类型] [文件名] [额外参数...]
```

### 参数说明

#### 类型参数

| 参数 | 说明 | 对应目录 |
|------|------|----------|
| `test` | 运行测试文件 | `build/test/` |
| `example` | 运行示例文件 | `build/example/` |
| `benchmark` | 运行压测文件 | `build/benchmark/` |
| `all-tests` | 运行所有测试 | `build/test/T*` |
| `-h, --help` | 显示帮助信息 | - |

#### 文件名参数

- 指定要运行的可执行文件名称（不含路径）
- 支持传递额外的命令行参数给目标程序

## 使用示例

### 1. 运行单个测试

```bash
# 运行 HTTP 解析器测试
./scripts/S1-Run.sh test T1-HttpParser

# 运行 Chunked 编码测试
./scripts/S1-Run.sh test T2-Chunk
```

### 2. 运行示例程序

```bash
# 运行 Echo 服务器示例
./scripts/S1-Run.sh example E1-EchoServer

# 运行 HTTP 客户端示例
./scripts/S1-Run.sh example E2-HttpClient
```

### 3. 运行压测程序

```bash
# 运行 Chunked 编码压测
./scripts/S1-Run.sh benchmark B1-Chunked

# 运行文件传输压测
./scripts/S1-Run.sh benchmark B2-FileTransfer
```

### 4. 批量运行所有测试

```bash
# 运行所有测试并生成统计报告
./scripts/S1-Run.sh all-tests
```

输出示例：
```
运行所有测试...

运行测试: T1-HttpParser
========================================
✓ T1-HttpParser 通过

运行测试: T2-Chunk
========================================
✓ T2-Chunk 通过

========================================
通过: 2
失败: 0
```

### 5. 传递额外参数

```bash
# 向测试程序传递参数
./scripts/S1-Run.sh test T5-HttpServer --port 9090

# 向示例程序传递参数
./scripts/S1-Run.sh example E1-EchoServer --threads 4
```

### 6. 查看帮助信息

```bash
./scripts/S1-Run.sh --help
```

## 工作流程

### 执行流程图

```
开始
  ↓
检查构建目录是否存在
  ↓
解析命令行参数
  ↓
根据类型定位可执行文件
  ↓
检查文件是否存在且可执行
  ↓
执行目标程序
  ↓
返回执行结果
```

### 目录结构要求

脚本依赖以下目录结构：

```
project_root/
├── scripts/
│   └── S1-Run.sh
└── build/
    ├── test/          # 测试可执行文件
    │   ├── T1-HttpParser
    │   ├── T2-Chunk
    │   └── ...
    ├── example/       # 示例可执行文件
    │   ├── E1-EchoServer
    │   └── ...
    └── benchmark/     # 压测可执行文件
        ├── B1-Chunked
        └── ...
```

## 错误处理

### 常见错误及解决方案

#### 1. 构建目录不存在

**错误信息**：
```
错误: 构建目录不存在，请先运行 cmake 构建项目
```

**解决方案**：
```bash
# 创建构建目录并编译项目
mkdir -p build
cd build
cmake ..
make
```

#### 2. 可执行文件不存在

**错误信息**：
```
错误: 可执行文件不存在: build/test/T1-HttpParser
提示: 请先编译项目
```

**解决方案**：
```bash
# 重新编译项目
cd build
make

# 或编译特定目标
make T1-HttpParser
```

#### 3. 未知类型参数

**错误信息**：
```
错误: 未知类型 'xxx'
```

**解决方案**：
使用正确的类型参数：`test`、`example`、`benchmark` 或 `all-tests`

#### 4. 缺少文件名参数

**错误信息**：
```
错误: 请指定测试文件名
```

**解决方案**：
```bash
# 正确的命令格式
./scripts/S1-Run.sh test T1-HttpParser
```

## 注意事项

### 使用建议

1. **首次使用前**：确保已完成项目编译，构建目录存在
2. **文件命名规范**：
   - 测试文件：`T[数字]-[名称]`（如 `T1-HttpParser`）
   - 示例文件：`E[数字]-[名称]`（如 `E1-EchoServer`）
   - 压测文件：`B[数字]-[名称]`（如 `B1-Chunked`）
3. **权限问题**：确保脚本有执行权限（`chmod +x scripts/S1-Run.sh`）
4. **路径问题**：可以从任意目录运行脚本，会自动定位项目根目录

### 最佳实践

1. **开发流程**：
   ```bash
   # 1. 修改代码
   # 2. 重新编译
   cd build && make

   # 3. 运行相关测试
   ../scripts/S1-Run.sh test T1-HttpParser

   # 4. 运行所有测试确保无回归
   ../scripts/S1-Run.sh all-tests
   ```

2. **调试流程**：
   ```bash
   # 使用 gdb 调试
   cd build/test
   gdb ./T1-HttpParser

   # 或使用 lldb (macOS)
   lldb ./T1-HttpParser
   ```

3. **性能分析**：
   ```bash
   # 先运行压测获取基准数据
   ./scripts/S1-Run.sh benchmark B1-Chunked

   # 修改代码后再次运行对比
   ./scripts/S1-Run.sh benchmark B1-Chunked
   ```

## 脚本实现细节

### 关键函数

#### 1. `check_build()`
检查构建目录是否存在，不存在则报错退出。

#### 2. `run_executable(type, name, args...)`
运行指定类型和名称的可执行文件，支持传递额外参数。

#### 3. `run_all_tests()`
遍历 `build/test/` 目录下所有 `T*` 开头的可执行文件并运行，统计通过和失败数量。

#### 4. `print_help()`
打印帮助信息，说明脚本用法和参数。

### 颜色输出

脚本使用 ANSI 转义码实现彩色输出：

- **绿色**：成功信息（`\033[0;32m`）
- **红色**：错误信息（`\033[0;31m`）
- **黄色**：警告信息（`\033[1;33m`）

## 扩展功能

### 自定义配置

可以通过修改脚本开头的变量来自定义行为：

```bash
# 自定义构建目录
BUILD_DIR="${PROJECT_ROOT}/custom_build"

# 自定义颜色
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
```

### 集成 CI/CD

在持续集成环境中使用：

```yaml
# .github/workflows/test.yml
- name: Run all tests
  run: |
    ./scripts/S1-Run.sh all-tests
```

## 相关脚本

- **S2-Check.sh**：验证测试结果和压测指标
- **S3-BenchmarkStaticFiles.sh**：静态文件服务压测
- **S4-TestRangeEtagManual.sh**：HTTP Range 和 ETag 手动测试
- **S5-TestRangeEtagStress.sh**：HTTP Range 和 ETag 压力测试

## 技术规格

| 项目 | 说明 |
|------|------|
| Shell 版本 | Bash 3.2+ |
| 依赖工具 | 无（纯 Bash 实现） |
| 支持平台 | Linux, macOS |
| 脚本位置 | `scripts/S1-Run.sh` |
| 配置文件 | 无 |

---

**文档版本**：v1.0
**创建日期**：2026-01-29
**维护团队**：galay-http 开发团队
