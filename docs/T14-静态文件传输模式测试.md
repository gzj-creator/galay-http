# T14-静态文件传输模式测试

## 测试概述

本文档记录静态文件传输模式的测试结果。测试覆盖了 MEMORY、CHUNK、SENDFILE、AUTO 四种传输模式，以及它们与 `mount()` 和 `mountHardly()` 的集成。

## 测试目标

验证 `StaticFileConfig` 类的传输模式配置功能，确保能够正确处理：
- MEMORY 模式（一次性加载到内存）
- CHUNK 模式（分块传输）
- SENDFILE 模式（零拷贝传输）
- AUTO 模式（根据文件大小自动选择）
- 配置参数的设置和获取
- 向后兼容性

## 测试场景

### 1. MEMORY 模式测试

#### 1.1 基本功能
- **测试内容**：配置为 MEMORY 模式并挂载目录
- **配置参数**：
  ```cpp
  config.setTransferMode(FileTransferMode::MEMORY);
  ```
- **验证点**：
  - 路由成功注册
  - 传输模式为 MEMORY
  - 文件一次性读入内存发送

#### 1.2 适用场景
- **小文件**：< 64KB
- **优点**：简单高效，无需分块
- **缺点**：大文件占用内存多

### 2. CHUNK 模式测试

#### 2.1 基本功能
- **测试内容**：配置为 CHUNK 模式并设置块大小
- **配置参数**：
  ```cpp
  config.setTransferMode(FileTransferMode::CHUNK);
  config.setChunkSize(32 * 1024);  // 32KB
  ```
- **验证点**：
  - 路由成功注册
  - 传输模式为 CHUNK
  - 块大小为 32KB

#### 2.2 适用场景
- **中等文件**：64KB - 1MB
- **优点**：内存占用可控，支持流式传输
- **缺点**：需要多次读写

### 3. SENDFILE 模式测试

#### 3.1 基本功能
- **测试内容**：配置为 SENDFILE 模式
- **配置参数**：
  ```cpp
  config.setTransferMode(FileTransferMode::SENDFILE);
  config.setSendFileChunkSize(1024 * 1024);  // 1MB
  ```
- **验证点**：
  - 路由成功注册
  - 传输模式为 SENDFILE
  - sendfile 块大小为 1MB

#### 3.2 适用场景
- **大文件**：> 1MB
- **优点**：零拷贝，性能最佳
- **缺点**：依赖操作系统支持

### 4. AUTO 模式测试

#### 4.1 自动选择逻辑
- **测试内容**：配置为 AUTO 模式并设置阈值
- **配置参数**：
  ```cpp
  config.setTransferMode(FileTransferMode::AUTO);
  config.setSmallFileThreshold(64 * 1024);   // 64KB
  config.setLargeFileThreshold(1024 * 1024); // 1MB
  ```
- **验证点**：
  - 10KB 文件 → MEMORY 模式
  - 100KB 文件 → CHUNK 模式
  - 2MB 文件 → SENDFILE 模式

#### 4.2 决策规则
```
文件大小 < 64KB        → MEMORY
64KB ≤ 文件大小 < 1MB  → CHUNK
文件大小 ≥ 1MB         → SENDFILE
```

### 5. mountHardly 集成测试

#### 5.1 MEMORY 模式
- **测试内容**：`mountHardly()` 使用 MEMORY 模式
- **验证点**：
  - 所有文件预加载到内存
  - 为每个文件创建精确路由
  - 路由数量正确

#### 5.2 SENDFILE 模式
- **测试内容**：`mountHardly()` 使用 SENDFILE 模式
- **验证点**：
  - 文件路径记录但不预加载
  - 运行时使用 sendfile 传输

#### 5.3 AUTO 模式
- **测试内容**：`mountHardly()` 使用 AUTO 模式
- **验证点**：
  - 根据每个文件大小选择模式
  - 小文件预加载，大文件记录路径

### 6. 配置参数测试

#### 6.1 默认值验证
- **测试内容**：验证默认配置参数
- **默认值**：
  - `transfer_mode` = AUTO
  - `small_file_threshold` = 64KB
  - `large_file_threshold` = 1MB
  - `chunk_size` = 64KB
  - `sendfile_chunk_size` = 10MB

#### 6.2 自定义配置
- **测试内容**：设置自定义配置参数
- **验证点**：所有参数正确设置和获取

### 7. 向后兼容性测试

#### 7.1 不提供配置参数
- **测试内容**：调用 `mount()` 和 `mountHardly()` 不传配置
- **验证点**：
  - 使用默认配置（AUTO 模式）
  - 功能正常工作
  - 向后兼容

## 测试用例列表

| 编号 | 测试用例 | 模式 | 预期结果 |
|------|---------|------|---------|
| 1 | MEMORY 模式基本功能 | MEMORY | ✓ 一次性加载 |
| 2 | CHUNK 模式基本功能 | CHUNK | ✓ 分块传输 |
| 3 | SENDFILE 模式基本功能 | SENDFILE | ✓ 零拷贝传输 |
| 4 | AUTO 模式小文件 | AUTO | ✓ 选择 MEMORY |
| 5 | AUTO 模式中等文件 | AUTO | ✓ 选择 CHUNK |
| 6 | AUTO 模式大文件 | AUTO | ✓ 选择 SENDFILE |
| 7 | mountHardly + MEMORY | Integration | ✓ 预加载成功 |
| 8 | mountHardly + SENDFILE | Integration | ✓ 路径记录 |
| 9 | mountHardly + AUTO | Integration | ✓ 智能选择 |
| 10 | 默认配置参数 | Config | ✓ 默认值正确 |
| 11 | 自定义配置参数 | Config | ✓ 设置成功 |
| 12 | 向后兼容性 | Compatibility | ✓ 兼容旧代码 |

## 测试代码位置

- **文件路径**：`/Users/gongzhijie/Desktop/projects/git/galay-http/test/T14-StaticFileTransferModes.cc`
- **测试函数数量**：7 个
- **代码行数**：284 行

## 运行测试

### 编译测试

```bash
cd build
cmake ..
make T14-StaticFileTransferModes
```

### 运行测试

```bash
./test/T14-StaticFileTransferModes
```

### 预期输出

```
========================================
Static File Transfer Modes Tests
========================================

=== Test 1: MEMORY Transfer Mode ===
✓ MEMORY mode route registered
✓ Transfer mode is MEMORY
✓ Test 1 passed!

=== Test 2: CHUNK Transfer Mode ===
✓ CHUNK mode route registered
✓ Transfer mode is CHUNK with 32KB chunks
✓ Test 2 passed!

=== Test 3: SENDFILE Transfer Mode ===
✓ SENDFILE mode route registered
✓ Transfer mode is SENDFILE with 1MB chunks
✓ Test 3 passed!

=== Test 4: AUTO Transfer Mode ===
✓ AUTO mode route registered
✓ Small file (10KB) -> MEMORY mode
✓ Medium file (100KB) -> CHUNK mode
✓ Large file (2MB) -> SENDFILE mode
✓ Test 4 passed!

...

========================================
All tests passed! ✓
========================================
```

## 测试结论

### 功能验证

✅ **MEMORY 模式**：适合小文件，简单高效
✅ **CHUNK 模式**：适合中等文件，内存可控
✅ **SENDFILE 模式**：适合大文件，性能最佳
✅ **AUTO 模式**：智能选择，开箱即用
✅ **配置灵活**：支持自定义阈值和块大小
✅ **向后兼容**：不破坏现有代码

### 性能对比

| 模式 | 内存占用 | CPU 占用 | 适用文件大小 | 性能 |
|------|---------|---------|------------|------|
| MEMORY | 高 | 低 | < 64KB | ⭐⭐⭐ |
| CHUNK | 中 | 中 | 64KB - 1MB | ⭐⭐⭐⭐ |
| SENDFILE | 低 | 极低 | > 1MB | ⭐⭐⭐⭐⭐ |
| AUTO | 自适应 | 自适应 | 任意 | ⭐⭐⭐⭐ |

### 模式选择指南

#### MEMORY 模式
```cpp
StaticFileConfig config;
config.setTransferMode(FileTransferMode::MEMORY);
router.mount("/static", "./public", config);
```
- **适用**：小文件（< 64KB）
- **场景**：图标、小图片、CSS、JS

#### CHUNK 模式
```cpp
StaticFileConfig config;
config.setTransferMode(FileTransferMode::CHUNK);
config.setChunkSize(64 * 1024);  // 64KB
router.mount("/media", "./media", config);
```
- **适用**：中等文件（64KB - 1MB）
- **场景**：普通图片、音频文件

#### SENDFILE 模式
```cpp
StaticFileConfig config;
config.setTransferMode(FileTransferMode::SENDFILE);
config.setSendFileChunkSize(10 * 1024 * 1024);  // 10MB
router.mount("/downloads", "./files", config);
```
- **适用**：大文件（> 1MB）
- **场景**：视频、大型下载文件

#### AUTO 模式（推荐）
```cpp
StaticFileConfig config;
config.setTransferMode(FileTransferMode::AUTO);
config.setSmallFileThreshold(64 * 1024);
config.setLargeFileThreshold(1024 * 1024);
router.mount("/assets", "./assets", config);
```
- **适用**：混合文件大小
- **场景**：通用静态资源目录

### 最佳实践

1. **默认使用 AUTO 模式**：适应各种文件大小
2. **根据场景调整阈值**：优化性能
3. **大文件优先 SENDFILE**：获得最佳性能
4. **小文件考虑 mountHardly + MEMORY**：减少磁盘 I/O
5. **监控内存使用**：避免 MEMORY 模式占用过多内存

### 技术细节

#### SENDFILE 系统调用
- **Linux**：`sendfile()`
- **macOS/BSD**：`sendfile()`
- **优点**：零拷贝，数据直接从文件到 socket
- **限制**：需要操作系统支持

#### CHUNK 传输
- **实现**：循环读取固定大小的块
- **优点**：内存占用固定
- **适用**：流式传输

---

**测试日期**：2026-01-29
**测试人员**：galay-http 开发团队
**文档版本**：v1.0
