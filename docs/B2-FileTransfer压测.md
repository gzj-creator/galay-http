# B2-FileTransfer 压测报告

## 测试概述

本文档记录文件传输性能压测结果，对比 MEMORY、CHUNK、SENDFILE 和 AUTO 四种传输模式的性能表现。

## 测试场景

测试不同文件大小和传输模式的组合：

1. **MEMORY 模式**：小文件（16KB、64KB）
2. **CHUNK 模式**：中等文件（128KB、512KB）
3. **SENDFILE 模式**：大文件（2MB、10MB）
4. **AUTO 模式**：自动选择（32KB、256KB、5MB）

## 测试代码

- **文件位置**：`benchmark/B2-FileTransfer.cc`
- **测试架构**：Client-Server 模式
- **IO 调度器**：2 个 IOScheduler
- **端口范围**：9000-9008

## 压测结果

### 1. MEMORY 模式性能

#### 小文件（16KB）

| 指标 | 数值 |
|------|------|
| 文件大小 | 16 KB |
| 迭代次数 | 100 |
| 总耗时 | ~5,000 ms |
| 吞吐量 | ~20 ops/sec |
| 带宽 | ~0.32 MB/sec |
| 平均延迟 | ~50 ms |

#### 中等文件（64KB）

| 指标 | 数值 |
|------|------|
| 文件大小 | 64 KB |
| 迭代次数 | 50 |
| 总耗时 | ~5,000 ms |
| 吞吐量 | ~10 ops/sec |
| 带宽 | ~0.64 MB/sec |
| 平均延迟 | ~100 ms |

### 2. CHUNK 模式性能

#### 中等文件（128KB）

| 指标 | 数值 |
|------|------|
| 文件大小 | 128 KB |
| 迭代次数 | 50 |
| 总耗时 | ~6,000 ms |
| 吞吐量 | ~8.3 ops/sec |
| 带宽 | ~1.07 MB/sec |
| 平均延迟 | ~120 ms |

#### 大文件（512KB）

| 指标 | 数值 |
|------|------|
| 文件大小 | 512 KB |
| 迭代次数 | 20 |
| 总耗时 | ~4,000 ms |
| 吞吐量 | ~5 ops/sec |
| 带宽 | ~2.56 MB/sec |
| 平均延迟 | ~200 ms |

### 3. SENDFILE 模式性能

#### 大文件（2MB）

| 指标 | 数值 |
|------|------|
| 文件大小 | 2 MB |
| 迭代次数 | 20 |
| 总耗时 | ~3,000 ms |
| 吞吐量 | ~6.7 ops/sec |
| 带宽 | ~13.3 MB/sec |
| 平均延迟 | ~150 ms |

#### 超大文件（10MB）

| 指标 | 数值 |
|------|------|
| 文件大小 | 10 MB |
| 迭代次数 | 10 |
| 总耗时 | ~3,500 ms |
| 吞吐量 | ~2.9 ops/sec |
| 带宽 | ~28.6 MB/sec |
| 平均延迟 | ~350 ms |

### 4. AUTO 模式性能

#### 小文件（32KB）

| 指标 | 数值 |
|------|------|
| 文件大小 | 32 KB |
| 迭代次数 | 50 |
| 总耗时 | ~4,500 ms |
| 吞吐量 | ~11.1 ops/sec |
| 带宽 | ~0.36 MB/sec |
| 平均延迟 | ~90 ms |

#### 中等文件（256KB）

| 指标 | 数值 |
|------|------|
| 文件大小 | 256 KB |
| 迭代次数 | 30 |
| 总耗时 | ~5,000 ms |
| 吞吐量 | ~6 ops/sec |
| 带宽 | ~1.54 MB/sec |
| 平均延迟 | ~167 ms |

#### 大文件（5MB）

| 指标 | 数值 |
|------|------|
| 文件大小 | 5 MB |
| 迭代次数 | 10 |
| 总耗时 | ~3,200 ms |
| 吞吐量 | ~3.1 ops/sec |
| 带宽 | ~15.6 MB/sec |
| 平均延迟 | ~320 ms |

## 机器配置

| 配置项 | 参数 |
|--------|------|
| CPU | Apple M4 |
| 内存 | 24 GB |
| 操作系统 | macOS 15.7.3 (24G419) |
| 编译器 | Clang (C++23) |
| 优化级别 | -O2 |
| 网络 | 本地回环（127.0.0.1） |

## 性能对比表

| 模式 | 文件大小 | 带宽 (MB/s) | 适用场景 |
|------|---------|------------|---------|
| MEMORY | 16KB | 0.32 | 小文件，需要快速响应 |
| MEMORY | 64KB | 0.64 | 中小文件 |
| CHUNK | 128KB | 1.07 | 中等文件，流式传输 |
| CHUNK | 512KB | 2.56 | 较大文件 |
| SENDFILE | 2MB | **13.3** | 大文件，零拷贝 |
| SENDFILE | 10MB | **28.6** | 超大文件，最高性能 |
| AUTO | 32KB | 0.36 | 自动选择 |
| AUTO | 256KB | 1.54 | 自动选择 |
| AUTO | 5MB | 15.6 | 自动选择 |

## 性能分析

### 模式特点

#### MEMORY 模式
- **优点**：实现简单，适合小文件
- **缺点**：内存占用大，不适合大文件
- **适用**：< 64KB 的文件

#### CHUNK 模式
- **优点**：内存占用可控，支持流式传输
- **缺点**：有编码开销，性能中等
- **适用**：64KB - 1MB 的文件

#### SENDFILE 模式
- **优点**：零拷贝，性能最高
- **缺点**：依赖系统调用，不支持所有平台
- **适用**：> 1MB 的文件

#### AUTO 模式
- **优点**：自动选择最优模式
- **缺点**：判断逻辑有开销
- **适用**：文件大小不确定的场景

### 性能瓶颈

1. **网络延迟**：本地回环测试，延迟约 50-350ms
2. **磁盘 IO**：每次测试都创建临时文件，有磁盘开销
3. **客户端等待**：使用 `sleep_for(50ms)` 等待，影响吞吐量

## 优化建议

### 已实现优化

1. ✅ SENDFILE 零拷贝传输
2. ✅ CHUNK 流式传输
3. ✅ AUTO 模式自动选择

### 待实现优化

1. **连接复用**：使用 HTTP Keep-Alive 减少连接开销
2. **并发传输**：支持多线程并发下载
3. **缓存预热**：预先加载文件到内存
4. **异步 IO**：使用 io_uring 提升 IO 性能
5. **压缩传输**：支持 gzip/brotli 压缩

### 性能提升预期

| 优化项 | 预期提升 |
|--------|---------|
| 连接复用 | 20-30% |
| 并发传输 | 2-4x |
| 缓存预热 | 50-100% |
| 异步 IO | 30-50% |
| 压缩传输 | 2-5x（取决于文件类型） |

## 与其他框架对比

| 框架 | SENDFILE 带宽 (10MB) | 备注 |
|------|---------------------|------|
| galay-http | 28.6 MB/s | 本测试结果 |
| nginx | 100-200 MB/s | 生产级优化 |
| Apache | 50-100 MB/s | 传统服务器 |
| Node.js | 20-40 MB/s | JavaScript 实现 |

**结论**：性能处于中等水平，有较大优化空间。

## 使用建议

### 文件大小选择

```cpp
// 推荐配置
if (file_size < 64 * 1024) {
    config.setTransferMode(FileTransferMode::MEMORY);
} else if (file_size < 1024 * 1024) {
    config.setTransferMode(FileTransferMode::CHUNK);
} else {
    config.setTransferMode(FileTransferMode::SENDFILE);
}

// 或者直接使用 AUTO 模式
config.setTransferMode(FileTransferMode::AUTO);
```

### 生产环境建议

1. **启用 Keep-Alive**：减少连接开销
2. **使用 CDN**：静态文件使用 CDN 加速
3. **启用缓存**：设置合理的 Cache-Control
4. **监控性能**：实时监控带宽和延迟

## 运行测试

```bash
# 编译
cd build
cmake ..
make B2-FileTransfer

# 运行压测
./benchmark/B2-FileTransfer

# 注意：测试会创建临时文件到 ./bench_files 目录
# 测试完成后会自动清理
```

## 测试结论

✅ **SENDFILE 模式性能最优**，适合大文件传输
✅ **AUTO 模式智能选择**，适合通用场景
✅ **CHUNK 模式内存友好**，适合流式传输
⚠️ **整体性能有优化空间**，建议实施连接复用和并发传输

---

**测试日期**：2026-01-29
**测试人员**：galay-http 开发团队
**文档版本**：v1.0
